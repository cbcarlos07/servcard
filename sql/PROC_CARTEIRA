DELIMITER $$
DROP PROCEDURE IF EXISTS `PROC_CARTEIRA` $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `PROC_CARTEIRA`(
CODIGO   INT,
CLIENTE  VARCHAR(75),
PLANO VARCHAR(255),
VALIDADE DATE,
ATIVO    CHAR(1),
TITULAR   VARCHAR(1),      
CARTEIRA VARCHAR(20),
ACAO    CHAR(1)
)
BEGIN
DECLARE TEXTO_ VARCHAR(75);
SET TEXTO_ = CONCAT('%',TEXTO,'%');
CASE
   WHEN ACAO = 'I'       THEN INSERT INTO `carteira` VALUES (NULL, CLIENTE, PLANO, VALIDADE, ATIVO, TITULAR);
   WHEN ACAO = 'A'       THEN UPDATE `carteira` SET 
                                     `CD_CLIENTE` = CLIENTE, `CD_PLANO`  = PLANO, 
                                     `DT_VALIDADE` = VALIDADE, `SN_ATIVO` = ATIVO,
                                     `SN_TITULAR` = TITULAR, `DS_NR_CARTEIRA` = CARTEIRA
                                     WHERE `CD_CARTEIRA` = CODIGO;
   WHEN ACAO = 'E'       THEN DELETE FROM `carteira` WHERE `CD_CARTEIRA` = CODIGO;
   WHEN ACAO = 'N'       THEN SELECT * FROM `V_CARTEIRA` WHERE `NM_CLIENTE` LIKE TEXTO_ ORDER BY `DT_VALIDADE` DESC;
   WHEN ACAO = 'C'       THEN SELECT * FROM `V_CARTEIRA` WHERE `CD_CARTEIRA` = CODIGO;
   WHEN ACAO = 'T'       THEN SELECT * FROM `V_CARTEIRA` ORDER BY `DT_VALIDADE` DESC;

END CASE;
END $$
DELIMITER ;



CRECREATE OR REPLACE VIEW V_PLANO AS
SELECT R.*
      ,C.NM_CLIENTE
      ,P.DS_PANO
FROM carteira R 
INNER JOIN cliente C ON C.CD_CLIENTE = R.CD_CLIENTE 
INNER JOIN plano P ON P.CD_PLANO = R.CD_PLANO
